# Updated nginx configuration for apromarketing.com production
# Includes critical SSE support, caching, and optimization

# Upstream definitions
upstream main_site {
    server localhost:8888;
    keepalive 64;
}

upstream app_frontend {
    server localhost:8080;
    keepalive 64;
}

upstream app_api {
    server localhost:8000;
    keepalive 64;
}

upstream app_blog {
    server localhost:2368;
    keepalive 64;
}

# Main site - apromarketing.com
server {
    server_name apromarketing.com www.apromarketing.com;

    # CRITICAL: SSE Routes for Demo functionality (MUST come before main location block)
    location ~ ^/(demo|demo-stream) {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # CRITICAL SSE settings - Without these the demo animations will break!
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;
        proxy_send_timeout 24h;
        chunked_transfer_encoding off;
        add_header X-Accel-Buffering no;
    }

    # Ghost API routes with brief caching and CORS support
    location ~ ^/api/ghost-posts- {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache Ghost API responses briefly for performance
        proxy_cache_valid 200 5m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Blog and tag routes with SEO-optimized caching
    location ~ ^/(blog|tag)/ {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Cache blog pages for better performance and SEO
        proxy_cache_valid 200 10m;
        proxy_cache_key "$scheme$request_method$host$request_uri";
        add_header X-Cache-Status $upstream_cache_status;
    }

    # Static assets with aggressive caching for performance
    location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot|webp)$ {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Long-term caching for static assets
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    # SEO files with appropriate caching
    location ~ ^/(robots\.txt|sitemap\.xml)$ {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        expires 1d;
        add_header Cache-Control "public";
    }

    # Newsletter signup with no caching (for real-time response)
    location = /newsletter-signup {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_Set_header X-Forwarded-Proto $scheme;

        # No caching for form submissions
        proxy_no_cache 1;
        proxy_cache_bypass 1;
    }

    # Main location block - handles all other routes (MUST be last)
    location / {
        proxy_pass http://main_site;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    listen 443 ssl; # managed by Certbot
    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/apromarketing.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/apromarketing.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# App subdomain - app.apromarketing.com (unchanged but improved)
server {
    server_name app.apromarketing.com;

    # API routes - must come before the main location block
    location /api {
        proxy_pass http://app_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection '';
        proxy_set_header Host $host;
        proxy_Set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # SSE support for API routes
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 86400s;
        proxy_connect_timeout 75s;

        # Remove /api prefix when forwarding to backend (optional)
        # rewrite ^/api/(.*) /$1 break;
    }

    # Frontend routes
    location / {
        proxy_pass http://app_frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    listen 443 ssl; # managed by Certbot
    listen [::]:443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/apromarketing.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/apromarketing.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# Blog subdomain - blog.apromarketing.com (unchanged)
server {
    server_name blog.apromarketing.com;

    # Frontend routes
    location / {
        proxy_pass http://app_blog;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_Set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/blog.apromarketing.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/blog.apromarketing.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}

# HTTP to HTTPS redirects (unchanged)
server {
    if ($host = www.apromarketing.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    if ($host = apromarketing.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name apromarketing.com www.apromarketing.com;
    return 404; # managed by Certbot
}

server {
    if ($host = app.apromarketing.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    listen [::]:80;
    server_name app.apromarketing.com;
    return 404; # managed by Certbot
}

server {
    if ($host = blog.apromarketing.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    server_name blog.apromarketing.com;
    listen 80;
    return 404; # managed by Certbot
}

# DEPLOYMENT INSTRUCTIONS:
#
# 1. Backup your current nginx config:
#    sudo cp /etc/nginx/sites-available/apromarketing.com /etc/nginx/sites-available/apromarketing.com.backup
#
# 2. Replace your current config with this file:
#    sudo cp nginx-config-updated.conf /etc/nginx/sites-available/apromarketing.com
#
# 3. Test the configuration:
#    sudo nginx -t
#
# 4. If test passes, reload nginx:
#    sudo systemctl reload nginx
#
# 5. Test demo functionality immediately at https://apromarketing.com
#    - The demo loading animation should work smoothly without buffering
#    - Blog posts should load in the side panel
#
# CRITICAL: The SSE configuration for /demo and /demo-stream routes is essential
# for proper demo functionality. Without it, the loading animations will freeze!